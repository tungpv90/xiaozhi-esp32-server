# Á¨¨‰∏ÄÈò∂ÊÆµÔºöÊûÑÂª∫VueÂâçÁ´Ø
FROM node:18 AS web-builder
WORKDIR /app
COPY main/manager-web/package*.json ./
RUN npm install
COPY main/manager-web .
RUN npm run build

# Á¨¨‰∫åÈò∂ÊÆµÔºöÊûÑÂª∫JavaÂêéÁ´Ø
FROM maven:3.9.4-eclipse-temurin-21 AS api-builder
WORKDIR /app
COPY main/manager-api/pom.xml .
COPY main/manager-api/src ./src
RUN mvn clean package -Dmaven.test.skip=true

# Á¨¨‰∏âÈò∂ÊÆµÔºöÊûÑÂª∫ÊúÄÁªàÈïúÂÉè
FROM bellsoft/liberica-runtime-container:jre-21-glibc

# ‚ö†Ô∏è ·∫£nh n√†y b·∫°n ƒëang d√πng apk, n√™n m√¨nh gi·ªØ nguy√™n c√°ch c·ªßa b·∫°n
# c√†i nginx + tools
RUN apk update && \
    apk add --no-cache --repository=http://dl-cdn.alpinelinux.org/alpine/edge/testing/ \
        nginx \
        bash \
        fontconfig \
        ttf-dejavu \
        msttcorefonts-installer \
        dos2unix \
    && ACCEPT_EULA=Y apk add --no-cache msttcorefonts-installer \
    && fc-cache -f -v \
    && rm -rf /var/cache/apk/*

# Êõ¥Êñ∞Â≠ó‰ΩìÁºìÂ≠ò
RUN (printf 'YES\n' | update-ms-fonts || true) && fc-cache -f -v

# ÈÖçÁΩÆNginx
COPY docs/docker/nginx.conf /etc/nginx/nginx.conf

# Â§çÂà∂ÂâçÁ´ØÊûÑÂª∫‰∫ßÁâ©
COPY --from=web-builder /app/dist /usr/share/nginx/html

# Â§çÂà∂JavaÂêéÁ´ØJARÂåÖ
COPY --from=api-builder /app/target/xiaozhi-esp32-api.jar /app/xiaozhi-esp32-api.jar

# ÂêØÂä®ËÑöÊú¨Ôºà‰ªéWindowsËøáÊù•ÁöÑÂèØËÉΩÊòØCRLFÔºâ
COPY docs/docker/start.sh /start.sh

# üîë chuy·ªÉn CRLF -> LF v√† c·∫•p quy·ªÅn th·ª±c thi
RUN dos2unix /start.sh && chmod +x /start.sh

EXPOSE 8002

CMD ["/start.sh"]
